(function(a){a.Profile=function(e){var d={},c=$.extend({target:"body",bindTo:a,fields:[{id:"name",required:true},{id:"email",required:true,validator:"email"},{id:"password",required:true,type:"password",validator:"password"},{id:"password-2",required:true,type:"password"}]},e);var f=function(h){$('<span class="pdp-form-messages ui-state-error">'+h+"</span>").appendTo(".pdp-form");$("#pdp-signup-button").removeClass("pdp-input-button-disabled").val("Update")};var g=function(){$("#pdp-password-container").toggle(this.checked)};var b=function(h){$("#pdp-name").val(h.Name);$("#pdp-email").val(h.Email)};d.init=Azavea.tryCatch("init profile",function(){a.Data.path="../";PDP.Widget.Login({target:"#login",profileUrl:"user/profile.aspx",logoutUrl:"default.aspx",adminUrl:"admin/manage-users.aspx",appUrl:c.appUrl}).init();a.Util.initLoginStatus();$(".pdp-input:first").focus();$("#pdp-change-password").attr("checked",false);g();a.Data.getUser(c.userName,b);$("#pdp-change-password").change(g);$("#pdp-password-2").keyup(function(h){if(h.which===13){$("#pdp-update-button").click()}});$("#pdp-email").keyup(function(h){if(h.which===13){$("#pdp-update-button").click()}});$("#pdp-update-button").button().click(function(){if(!$(this).hasClass("pdp-input-button-disabled")){$(".pdp-form-messages").remove();$(this).addClass("pdp-input-button-disabled").val("Saving...");if(a.Form.validate(c.fields,{},c.target,a.prefix)){var j=$("#pdp-password").val(),i=$("#pdp-name").val(),h=$("#pdp-email").val();roles="";a.Data.updateUser(c.userName,i,h,j,roles,function(k){a.Util.quickAlert("Your profile has been updated.");$(c.bindTo).trigger("pdp-login-status-refresh",[k])},function(k){f(k)})}else{f("All fields are required.");$(".pdp-input-invalid:first").focus()}$(this).removeClass("pdp-input-button-disabled").val("Update")}});return d});return d}}(PDP));(function(a){a.Widget.Table=function(e){var f={},n=$.extend({target:"body",bindTo:a,messageSel:"pdp-table-message",pageSizes:[20,100,500],defaultPageSize:20,pagerTarget:null,extraCols:[],altRowClass:"pdp-table-row-alt-pdb"},e),q={},m,p={colIndex:-1,sortAsc:true},k={page:1,pageSize:n.defaultPageSize,totalPages:-1},b;var o=Azavea.tryCatch("trigger table data request",function(){$(n.bindTo).trigger("pdp-data-request",[k.page,k.pageSize,p.colIndex,p.sortAsc])});f.getState=Azavea.tryCatch("get table state",function(){return{page:k.page,pageSize:k.pageSize,sortColIndex:p.colIndex,sortAsc:p.sortAsc}});f.setPage=Azavea.tryCatch("set table page",function(y,x,z){if(y>0&&y<=k.totalPages){k.page=parseInt(y,10);k.pageSize=x;if(!z){o()}}});var u=Azavea.tryCatch("refresh table pager",function(){$(n.pagerTarget).show();$(".pdp-table-pager-totalpages",n.pagerTarget||n.target).html(k.totalPages);$(".pdp-table-pager-ctrl-curpage input",n.pagerTarget||n.target).val(k.page)});var h=Azavea.tryCatch("refresh table pager",function(x){if(b){clearTimeout(b);b=0}b=setTimeout(function(){var y=$(".pdp-table-pager-ctrl-curpage input",n.pagerTarget||n.target).val();f.setPage(y,k.pageSize)},1200)});var i=Azavea.tryCatch("pager click events",function(x){var y=x.target.id;switch(y){case"pdp-table-pager-first":f.setPage(1,k.pageSize);break;case"pdp-table-pager-prev":f.setPage((k.page-1),k.pageSize);break;case"pdp-table-pager-next":f.setPage((k.page+1),k.pageSize);break;case"pdp-table-pager-last":f.setPage(k.totalPages,k.pageSize);break}});var w=Azavea.tryCatch("init table pager",function(){if($(".pdp-table-pager",n.pagerTarget||n.target).length){return}$('<div class="pdp-table-pager"><div class="pdp-table-pager-ctrl pdp-table-pager-ctrl-pagesize"><span class="pdp-table-pager-ctrl">Show:</span><select id="pdp-table-pager-ctrl-pagesize-selector"></select></div><div class="pdp-table-pager-ctrl pdp-table-pager-ctrl-first ui-corner-all pdp-border"><span id="pdp-table-pager-first" class="ui-icon ui-icon-arrowstop-1-w"></span></div><div class="pdp-table-pager-ctrl pdp-table-pager-ctrl-prev ui-corner-all pdp-border"><span id="pdp-table-pager-prev" class="ui-icon ui-icon-arrow-1-w"></span></div><div class="pdp-table-pager-ctrl pdp-table-pager-ctrl-curpage"><input id="pdp-table-pager-ctrl-curpage-input" type="text" value="0"/> of <span class="pdp-table-pager-totalpages">0</span></div><div class="pdp-table-pager-ctrl pdp-table-pager-ctrl-next ui-corner-all pdp-border"><span id="pdp-table-pager-next" class="ui-icon ui-icon-arrow-1-e"></span></div><div class="pdp-table-pager-ctrl pdp-table-pager-ctrl-last ui-corner-all pdp-border"><span id="pdp-table-pager-last" class="ui-icon ui-icon-arrowstop-1-e"></span></div></div>').appendTo(n.pagerTarget||n.target);var x="",y;for(y=0;y<n.pageSizes.length;y++){var z="";if(n.pageSizes[y]===n.defaultPageSize){z=' selected = "selected"'}x+='<option value="'+n.pageSizes[y]+'"'+z+">"+n.pageSizes[y]+"</option>"}$("#pdp-table-pager-ctrl-pagesize-selector",n.pagerTarget||n.target).append(x).change(function(A){f.setPage(1,this.value)});$("#pdp-table-pager-ctrl-curpage-input",n.pagerTarget||n.target).val(k.page).keyup(h);$(".pdp-table-pager",n.pagerTarget||n.target).click(i)});var d=Azavea.tryCatch("toggle col sorting",function(y,C){var A=q.ExtraAttrs?q.ExtraAttrs.length:0,B='<span class="pdp-table-col-sorting right ui-icon ui-icon-triangle-1-n"></span>',z='<span class="pdp-table-col-sorting right ui-icon ui-icon-triangle-1-s"></span>';if(p.colIndex===y){p.sortAsc=!p.sortAsc;var x=$("tr th:nth-child("+(p.colIndex+1+A)+")",n.target);if(p.sortAsc){x.removeClass("pdp-table-col-sortdesc").addClass("pdp-table-col-sortasc").find("span.pdp-table-col-sorting").remove();$("div.ktable-th-text",x).before(B)}else{x.removeClass("pdp-table-col-sortasc").addClass("pdp-table-col-sortdesc").find("span.pdp-table-col-sorting").remove();$("div.ktable-th-text",x).before(z)}}else{p.colIndex=y;p.sortAsc=C?true:false;$(".pdp-table-col-sortasc,.pdp-table-col-sortdesc").removeClass("pdp-table-col-sortasc pdp-table-col-sortdesc").find("span.pdp-table-col-sorting").remove();$("tr th:nth-child("+(p.colIndex+1+A)+")",n.target).addClass(C?"pdp-table-col-sortasc":"pdp-table-col-sortdesc").find("div.ktable-th-text").before(C?B:z)}o()});var t=Azavea.tryCatch("enable col resize",function(y){var z=q.ExtraAttrs?q.ExtraAttrs.length:0;var B,x,A="<colgroup>";for(B=0;B<z;B++){A+='<col class="pdp-table-col-extra"/>'}for(B=0;B<(q.Attrs.length);B++){x="";if(!m[B]){x=" pdp-table-col-hide"}A+='<col class="pdp-table-col-index-'+B+x+'"/>'}A+="</colgroup>";y.prepend(A);y.ktable_colsizable({dragMove:true,dragProxy:"area",dragOpacity:0.1})});var l=Azavea.tryCatch("refresh col visibility",function(x){$.each(m,function(z,y){if(y){$(".pdp-table-col-index-"+z,x).removeClass("pdp-table-col-hide")}else{$(".pdp-table-col-index-"+z,x).addClass("pdp-table-col-hide")}})});f.showCol=Azavea.tryCatch("show col",function(x){m[x]=true;$(".pdp-table-col-index-"+x,n.target).removeClass("pdp-table-col-hide")});f.hideCol=Azavea.tryCatch("hide col",function(x){m[x]=false;$(".pdp-table-col-index-"+x,n.target).addClass("pdp-table-col-hide")});var r=Azavea.tryCatch("get body row",function(D,x,C){var B=new a.StringBuffer(),y,z,A;B.append('<tr class="'+C+'">');if(q.ExtraAttrs){for(y=0;y<q.ExtraAttrs.length;y++){z=q.ExtraAttrs[y];B.append('<td class="');B.append(C);B.append('">');B.append(a.Util.renderers[z.ValType](z.Name,D,x,q.Attrs));B.append("</td>")}}for(y=0;y<q.Attrs.length;y++){A=x[y];z=q.Attrs[y];if(a.Util.renderers[z.ValType]){A=a.Util.renderers[z.ValType](x[y],D,x,q.Attrs)}B.append('<td class="pdp-column-render-');B.append(z.ValType);B.append(" pdp-table-col-index-");B.append(y);if(!m[y]){B.append(" pdp-table-col-hide")}B.append('">');B.append(A);B.append("</td>")}B.append("</tr>");return B.toString()});var g=Azavea.tryCatch("get table widget rows",function(C){var x=$("<tbody></tbody>"),B=new a.StringBuffer(),A,D,y,z="";if(q.ContextRows){for(A=0;A<q.ContextRows.length;A++){y=q.ContextRows[A];if(A===q.ContextRows.length-1){z=" pdp-widget-table-context-row-last"}B.append(r(y[C],y,"pdp-widget-table-context-row"+z))}}for(A=0;A<q.Values.length;A++){y=q.Values[A];D=y[C];if(!C){D=A}B.append(r(D,y,""))}x.append(B.toString());$("tr:odd",x).addClass(n.altRowClass);return x});var v=Azavea.tryCatch("render table widget table",function(){var x=$(n.target).empty(),y,z='<table class="pdp-table"><thead><tr>';if(q.ExtraAttrs){$.each(q.ExtraAttrs,function(A,B){z+='<th class="pdp-table-col-nosort">'+B.Name+"</th>"})}$.each(q.Attrs,function(C,D){var A="",B="";if(D.NotSortable){A=" pdp-table-col-nosort"}else{A=" ui-state-default"}if(!m[C]){A+=" pdp-table-col-hide"}if(D.ValType==="text"){B=" pdp-table-col-sort-invert"}z+='<th class="'+B+A+" pdp-table-col-index-"+C+'" rel="'+C+'">'+D.Name+"</th>"});z+="</tr></thead></table>";y=$(z).append(g());t(y);y.appendTo(x)});var s=Azavea.tryCatch("init col state",function(){p={colIndex:-1,sortAsc:true};m=[];$.each(q.Attrs,function(x,y){m.push(y.OnByDefault)})});var c=Azavea.tryCatch("handle col vis response",function(y,z,x){m=z;if(x||x===0){if(m[x]){f.showCol(x)}else{f.hideCol(x)}}else{l()}});var j=Azavea.tryCatch("table handle new data response",function(z,A){try{var y=Azavea.superEquals(q.Attrs,A.Attrs);q=A;k.totalPages=Math.ceil(q.TotalResults/k.pageSize);$("."+n.messageSel).remove();$(n.target).show();if(q.TotalResults>0){if(y&&$("tbody",n.target).length!==0){$("tbody",n.target).remove();var B=a.Util.getAttrIndex(q.Attrs,"UID");var x=g(B);$("table",n.target).append(x).show()}else{s();v();w()}u()}else{if(y){$("tbody",n.target).remove();$("table",n.target).hide()}else{$(n.target).empty()}u();$(n.target).append('<div class="'+n.messageSel+'">No results.</div>')}}finally{$(n.bindTo).trigger("pdp-loading-finished")}});f.init=Azavea.tryCatch("init table widget",function(){$(n.bindTo).bind("pdp-data-response",j);$(n.bindTo).bind("pdp-data-force-update",function(){p.colIndex=-1;k.page=1;o()});$(n.bindTo).bind("pdp-criteria-reset",function(){$(n.target).hide();$(n.pagerTarget).hide()});$("th:not(.pdp-table-col-nosort)",n.target).live("click",function(x){var z=$(this),y=parseInt(z.attr("rel"),10),A=z.hasClass("pdp-table-col-sort-invert");d(y,A)});$(n.bindTo).bind("pdb-column-visibility",c);return f});return f}}(PDP));(function(a){a.Widget.Login=function(n){var k={},m=$.extend({target:"body",bindTo:a,fields:[{id:"pdp-login-username",required:true},{id:"pdp-login-password",required:true}],adminUrl:"admin/manage-users.aspx",logoutUrl:"default.aspx",profileUrl:"user/profile.aspx",appUrl:""},n),b;var j=Azavea.tryCatch("clear form errors",function(){$(".input-invalid",b).removeClass("input-invalid");$(".pdp-form-messages",b).remove()});var i=Azavea.tryCatch("create and render the login form",function(){var p="",o="";b=$('<div class="pdp-header-panel pdp-login-panel pdp-closable-panel ui-corner-all pdp-shadow-drop"><h2>Log In</h2><div id="pdp-login-panel-close"><span class="ui-icon ui-icon-circle-close"></span></div><fieldset class=""><ul><li><label for="pdp-login-username" class="pdp-form-label">Username:</label><div class="pdp-form-ctrl"><input id="pdp-login-username" type="text" class="pdp-input pdp-input-shorttext" tabindex="1" /></div></li><li><label for="pdp-login-password" class="pdp-form-label">Password:</label><div class="pdp-form-ctrl"><input id="pdp-login-password" type="password" class="pdp-input pdp-input-shorttext" tabindex="2" /></div></li><li><div class="pdp-form-buttons"><button id="pdp-login-button" class="pdp-button pdp-input-button-primary" tabindex="3">Log In</button><a href="javascript:void(0);" id="pdp-show-password-reset">Forgot Password?</a></div></li></ul></fieldset></div>');p='<fieldset class="pdp-password-reset-container"><h2>Reset Password</h2><ul><li><label for="pdp-reset-password-username" class="">Enter your username to reset your password:</label><div class="pdp-form-ctrl"><input id="pdp-reset-password-username" type="text" class="pdp-input pdp-input-shorttext" tabindex="4" /></div></li></ul><div class="pdp-form-buttons"><button id="pdp-reset-password-button" value="Reset Password" class="pdp-button pdp-input-button-primary" tabindex="5">Reset Password</button></div></fieldset>';b.append(p).hide();$(".pdp-password-reset-container",b).hide();$("#pdp-login-password",b).keyup(function(q){if(q.which===13){$("#pdp-login-button").click()}});$("#pdp-reset-password-username",b).keyup(function(q){if(q.which===13){$("#pdp-reset-password-button").click()}});$("#pdp-login-panel-close",b).click(function(q){b.hide()});$("#pdp-show-password-reset",b).click(function(q){j();$(".pdp-password-reset-container").toggle()});o=$('<a href="javascript:void(0);" class="pdp-link pdp-header-link">Login</a>');o.click(function(q){if(b.is(":visible")){b.hide()}else{b.show();j();$(".pdp-input:first",".pdp-login-panel").focus()}});$(m.target).empty().append(o,b)});var d=Azavea.tryCatch("display login info",function(p){var r="",o="",q={};$("pdp-login-panel").remove();$("pdp-login-link").remove();r='Welcome,<a href="'+decodeURI(m.appUrl+m.profileUrl)+'" class="pdp-link pdp-header-link">'+p.Name+"</a>";if(p.Admin){o='<a href="'+decodeURI(m.appUrl+m.adminUrl)+'" class="pdp-link pdp-header-link">User Administration</a>'}q=$('<a href="javascript:void(0);" class="pdp-link pdp-header-link">Logout</a>');q.click(function(s){a.Data.logout(function(){window.location.href=decodeURIComponent(m.logoutUrl)})});$(m.target).empty().append(r,o,q)});var l=Azavea.tryCatch("init login",function(){$("#pdp-login-button").button().click(function(){if(!$(this).hasClass("pdp-input-button-disabled")){$(".pdp-form-messages").remove();$(this).addClass("pdp-input-button-disabled").val("Checking login...");if(a.Form.validate(m.fields,{},m.target)){var p=$("#pdp-login-username").val(),o=$("#pdp-login-password").val();a.Data.login(p,o,function(q){location.reload(true);$(m.bindTo).trigger("pdp-login-success",[q]);d(q)},function(q){c(q)})}else{c(a.Form.validationMsg);$(".pdp-input-invalid:first",".pdp-login-panel").focus()}}})});var g=Azavea.tryCatch("initialize password reset",function(){$("#pdp-reset-password-button").button().click(function(){$(".pdp-form-messages").remove();if(a.Form.validate([{id:"pdp-reset-password-username",required:true}],{},m.target)){var o=$("#pdp-reset-password-username").val();a.Data.resetPassword(o,function(p){h(p)},function(p){c(p)})}else{c(a.Form.validationMsg);$(".pdp-input-invalid:first",".pdp-login-panel").focus()}})});var f=Azavea.tryCatch("display error message",function(p,o){$('<div class="pdp-form-messages '+o+'">'+p+"</div>").appendTo(".pdp-login-panel");$("#pdp-login-button").removeClass("pdp-input-button-disabled").val("Log In")});var c=Azavea.tryCatch("display error message",function(o){f(o,"ui-state-error")});var h=Azavea.tryCatch("display error message",function(o){f(o,"")});var e=Azavea.tryCatch("refresh login panel",function(p,o){if(o){d(o)}else{i();l();g()}});k.init=Azavea.tryCatch("init widget login",function(){$(m.bindTo).bind("pdp-login-status-refresh",e);return k});return k}}(PDP));